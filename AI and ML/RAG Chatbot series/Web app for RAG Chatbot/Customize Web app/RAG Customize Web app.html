<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kareshma — Chat</title>

  <!-- New visual design CSS (overrides original style.css) -->
  <style>
    :root{
      --bg: #0f1724;
      --panel: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --accent: #6ee7b7;
      --muted: #94a3b8;
      --surface: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.02);
      --radius: 14px;
      --maxw: 900px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{
      height:100%;
      margin:0;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(110,231,183,0.04), transparent),
                  radial-gradient(900px 500px at 90% 90%, rgba(134,239,172,0.03), transparent),
                  var(--bg);
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      max-width: var(--maxw);
      margin: 40px auto;
      padding: 28px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 24px;
      align-items:start;
    }

    /* Left panel (profile + quick actions) */
    .left {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.03);
      border-radius: var(--radius);
      padding: 20px;
      min-height: 420px;
      display:flex;
      flex-direction:column;
      gap:16px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      backdrop-filter: blur(6px) saturate(120%);
    }

    .avatar {
      width:70px;
      height:70px;
      border-radius:14px;
      background: linear-gradient(135deg,#0ea5a4,#06b6d4);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:20px;
      color: #052023;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
      margin-bottom:6px;
    }

    .left h1{
      font-size:20px;
      margin:0;
      letter-spacing: -0.2px;
    }

    .left p { color: var(--muted); margin:0; font-size:13px; }

    .toggle-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:12px;
    }

    .toggle {
      display:flex;
      gap:10px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    .switch {
      width:46px;
      height:26px;
      background: rgba(255,255,255,0.06);
      border-radius:999px;
      position:relative;
      padding:3px;
      cursor:pointer;
    }
    .switch .knob{
      width:20px;
      height:20px;
      border-radius:50%;
      background:#fff;
      transform:translateX(0);
      transition:transform .18s ease;
      box-shadow: 0 4px 10px rgba(2,6,23,0.5);
    }
    .switch.on{ background: linear-gradient(90deg, #10b981, #06b6d4); }
    .switch.on .knob{ transform: translateX(20px); background: #052023; color: #fff; }

    .quick {
      margin-top: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip {
      font-size:13px;
      padding:8px 10px;
      background: var(--glass);
      border-radius:10px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.02);
      cursor:pointer;
    }
    .chip:active{ transform:scale(.99); }

    /* Right panel (chat) */
    .right {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      min-height:420px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.035);
      box-shadow: 0 10px 40px rgba(2,6,23,0.6);
    }

    .right .header {
      padding:18px 20px;
      display:flex;
      gap:12px;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,0.02);
    }
    .right .header h2{
      margin:0;
      font-size:16px;
    }
    .right .header .sub { color:var(--muted); font-size:13px; margin-left:auto; }

    .messages {
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
      height: calc(100% - 140px);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.0004), rgba(255,255,255,0.0002));
    }

    .msg {
      max-width:78%;
      padding:12px 14px;
      border-radius:12px;
      font-size:14px;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .msg.user {
      align-self:flex-end;
      background: linear-gradient(180deg,#052023,#06403a);
      color: #e6fff8;
      border-bottom-right-radius:4px;
    }
    .msg.bot {
      align-self:flex-start;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.02);
      color: #cfe8e0;
      border-bottom-left-radius:4px;
    }

    .loading {
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .dot {
      width:8px;
      height:8px;
      background:var(--muted);
      border-radius:50%;
      opacity:.8;
      transform: translateY(0);
      animation: wave 1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay:.12s; }
    .dot:nth-child(3){ animation-delay:.24s; }
    @keyframes wave {
      0% { transform: translateY(0); opacity:.6; }
      50% { transform: translateY(-6px); opacity:1; }
      100% { transform: translateY(0); opacity:.6; }
    }

    .composer {
      padding:14px;
      display:flex;
      gap:10px;
      align-items:center;
      border-top:1px solid rgba(255,255,255,0.02);
    }

    .composer input[type="text"]{
      flex:1;
      background: rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.02);
      padding:12px 14px;
      border-radius:10px;
      color: #e6eef6;
      font-size:14px;
      outline:none;
    }
    .composer input::placeholder{ color: #7f99ab; }

    .send {
      background: linear-gradient(90deg,#06b6d4,#10b981);
      border:none;
      padding:10px 14px;
      border-radius:10px;
      color:#052023;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(6,22,18,0.35);
    }
    .send:disabled{ opacity:.5; transform: none; cursor:default; }

    /* Small screens */
    @media (max-width:920px){
      .wrap{ grid-template-columns: 1fr; padding:16px; gap:12px; }
      .left{ order:2; min-height: 120px; flex-direction:row; align-items:center; }
      .left .avatar{ width:54px; height:54px; border-radius:10px; }
      .right{ order:1; min-height: 60vh; }
      .messages{ height: calc(100% - 128px); }
    }

    footer.note {
      max-width: var(--maxw);
      margin: 10px auto;
      color: var(--muted);
      font-size:13px;
      padding:0 28px;
    }

  </style>
</head>
<body>
  <div class="wrap">
    <aside class="left" aria-label="Profile & options">
      <div style="display:flex;gap:12px;align-items:center;">
        <div class="avatar">K</div>
        <div>
          <h1>Kareshma</h1>
          <p>Ask the bot about my projects, docs, or just brainstorm.</p>
        </div>
      </div>

      <div class="toggle-row" style="margin-top:6px;">
        <div class="toggle">Use knowledge base
          <span style="display:block;color:var(--muted);font-size:12px;margin-top:4px;">When on, requests go to /bedrock/invoke; otherwise /bedrock/query</span>
        </div>

        <!-- This is the exact same toggle behavior as original: checked === invoke endpoint -->
        <div id="kbSwitch" class="switch on" role="button" aria-pressed="true" title="Toggle knowledge base">
          <div class="knob"></div>
        </div>
      </div>

      <div style="margin-top:8px;color:var(--muted);font-size:13px;">Quick prompts</div>
      <div class="quick" id="quickPresets">
        <div class="chip">Give me a summary</div>
        <div class="chip">How to deploy on AWS?</div>
        <div class="chip">Explain the architecture</div>
        <div class="chip">Write README</div>
      </div>

      <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px;">
        <div style="font-size:12px;color:var(--muted)">Status: <strong id="statusLabel" style="color:var(--accent);">Ready</strong></div>
        <div style="font-size:12px;color:var(--muted)">Endpoint test: <button id="pingBtn" class="chip" style="padding:6px 10px;">Ping</button></div>
      </div>
    </aside>

    <main class="right" role="main" aria-label="Chat area">
      <div class="header">
        <h2>Kareshma's assistant</h2>
        <div class="sub" id="endpointIndicator">Using: <strong id="currentEndpoint">/bedrock/invoke</strong></div>
      </div>

      <div class="messages" id="messages" aria-live="polite">
        <!-- messages are appended here -->
      </div>

      <div class="composer" role="form" aria-label="Send a message">
        <input id="messageInput" type="text" placeholder="Type a message and press Enter — keep it short." autocomplete="off" />
        <button id="sendBtn" class="send">Send</button>
      </div>
    </main>
  </div>

  <div class="note" style="text-align:center;margin-top:10px;color:transparent;">.</div>
  <footer class="note">
    Implementation sends the user's raw text only to your existing endpoints: either /bedrock/invoke or /bedrock/query depending on the toggle.
  </footer>

  <!-- Script: keeps API calls and error handling compatible with the original. -->
  <script>
    (function () {
      // DOM refs
      const kbSwitch = document.getElementById('kbSwitch');
      const currentEndpointEl = document.getElementById('currentEndpoint');
      const messagesEl = document.getElementById('messages');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const quick = document.getElementById('quickPresets');
      const statusLabel = document.getElementById('statusLabel');
      const pingBtn = document.getElementById('pingBtn');

      // internal state
      let useKB = true; // matches original default: checkbox checked -> invoke
      updateEndpointIndicator();

      function updateEndpointIndicator(){
        currentEndpointEl.textContent = useKB ? '/bedrock/invoke' : '/bedrock/query';
      }

      // Toggle click handler
      kbSwitch.addEventListener('click', () => {
        useKB = !useKB;
        kbSwitch.classList.toggle('on', useKB);
        kbSwitch.setAttribute('aria-pressed', String(useKB));
        updateEndpointIndicator();
      });

      // Quick preset click
      quick.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip');
        if (!chip) return;
        messageInput.value = chip.textContent;
        messageInput.focus();
      });

      // Ping the backend to show basic error feedback (non-intrusive)
      pingBtn.addEventListener('click', async () => {
        statusLabel.textContent = 'Checking...';
        try {
          // Keep the ping usage consistent (query endpoint is safe for quick test)
          const resp = await fetch('/bedrock/query?text=' + encodeURIComponent('ping'));
          if (!resp.ok) throw new Error('Non-OK response');
          const d = await resp.json();
          statusLabel.textContent = 'OK';
          setTimeout(()=> statusLabel.textContent = 'Ready', 1300);
        } catch (err) {
          statusLabel.textContent = 'Error';
          console.error('Ping error', err);
          setTimeout(()=> statusLabel.textContent = 'Ready', 1800);
        }
      });

      // Helper to append messages
      function appendMessage(text, who = 'bot', opts = {}) {
        const el = document.createElement('div');
        el.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
        if (opts.isLoading) {
          // add typing indicator instead of text
          el.innerHTML = '<span class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
        } else {
          el.textContent = text;
        }
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return el;
      }

      // Send message routine (keeps exact param usage)
      async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;
        // Add user message visually
        appendMessage(text, 'user');
        messageInput.value = '';
        messageInput.focus();

        // Add loading message
        const loadingEl = appendMessage('', 'bot', { isLoading: true });

        // Choose endpoint exactly the same way as original file: invoke when KB is on, else query
        const endpoint = useKB ? '/bedrock/invoke' : '/bedrock/query';

        // Build URL exactly like original: GET with ?text=... (encodeURIComponent)
        const url = `${endpoint}?text=${encodeURIComponent(text)}`;

        try {
          const resp = await fetch(url, { method: 'GET' });
          // keep error handling compatible: if backend returns non-JSON or error, catch below
          if (!resp.ok) throw new Error('Network response not ok: ' + resp.status);
          const data = await resp.json();

          // Expect the original response shape: data.response
          // Only the user's text was sent — we did not prepend any system prompts or metadata.
          loadingEl.remove();
          if (data && typeof data.response === 'string') {
            appendMessage(data.response, 'bot');
          } else {
            // For safety, show the raw object when shape unrecognized (helpful for debugging)
            appendMessage('Unexpected response from server.', 'bot');
            console.warn('Unexpected API response shape:', data);
          }

        } catch (err) {
          console.error('Send error:', err);
          loadingEl.remove();
          appendMessage('Sorry, something went wrong. Please try again.', 'bot');
        }
      }

      // Event listeners
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Simple keyboard shortcut: Ctrl/Cmd+K to focus input
      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
          e.preventDefault();
          messageInput.focus();
        }
      });

      // Preserve scroll to bottom when new content arrives
      const observer = new MutationObserver(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
      observer.observe(messagesEl, { childList: true });

      // Accessibility: announce endpoint toggles
      kbSwitch.addEventListener('mouseenter', () => {
        kbSwitch.title = useKB ? 'Knowledge base enabled — requests go to /bedrock/invoke' : 'Knowledge base disabled — requests go to /bedrock/query';
      });

      // Prefill a friendly greeting from the bot
      appendMessage('Hello — ask me about projects or docs. Toggle the option on the left to switch between /bedrock/invoke and /bedrock/query.', 'bot');

    })();
  </script>
</body>
</html>
